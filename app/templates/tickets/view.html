{% extends "base.html" %}

{% block content %}
<div class="flex items-center justify-between">
  <h1 class="text-2xl font-bold">Ticket #{{ ticket.id }} — {{ ticket.subject }}</h1>
  <a class="text-blue-500 hover:underline" href="{{ url_for('tickets.index') }}">All tickets</a>
</div>

<div class="mt-2 text-slate-600 dark:text-slate-300">Priority: {{ ticket.priority }} • Status: {{ ticket.status }} • Assigned: {{ ticket.assigned_to.email if ticket.assigned_to else '—' }} • Created {{ ticket.created_at.strftime('%Y-%m-%d %H:%M') }}</div>

<div class="my-4">
  <h2 class="text-xl font-semibold">Description</h2>
  <div class="p-3 bg-white dark:bg-slate-800 rounded border border-slate-200 dark:border-slate-700">{{ ticket.description or '—' }}</div>
</div>

<div class="my-4">
  <h2 class="text-xl font-semibold">Comments</h2>
  {% if comments %}
    <ul>
      {% for c in comments %}
      <li class="bg-white dark:bg-slate-800 shadow rounded p-3 mb-3">
        <div class="text-slate-700 dark:text-slate-100">{{ c.body }}</div>
        <div class="text-xs text-slate-500 mt-1">By {{ c.author.email if c.author else c.author_id }} at {{ c.created_at.strftime('%Y-%m-%d %H:%M') }}</div>
      </li>
      {% endfor %}
    </ul>
  {% else %}
    <p class="text-slate-600">No comments yet.</p>
  {% endif %}
</div>

<div class="my-4 grid grid-cols-1 md:grid-cols-2 gap-4">
  <form method="POST" action="{{ url_for('tickets.view', ticket_id=ticket.id) }}">
    <h3 class="text-lg font-semibold mb-2">Add Comment</h3>
    {{ comment_form.hidden_tag() }}
    <div class="mb-3">{{ comment_form.body(class="w-full border rounded px-3 py-2", rows=3) }}</div>
    {{ comment_form.submit(class="bg-blue-600 hover:bg-blue-700 text-white font-medium px-4 py-2 rounded") }}
  </form>

  <form method="POST" action="{{ url_for('tickets.update_status', ticket_id=ticket.id) }}">
    <h3 class="text-lg font-semibold mb-2">Update Status</h3>
    {{ status_form.hidden_tag() }}
    <div class="mb-3">{{ status_form.status(class="border rounded px-2 py-1", value=ticket.status) }}</div>
    {{ status_form.submit(class="bg-slate-700 hover:bg-slate-800 text-white font-medium px-4 py-2 rounded") }}
  </form>

  {% if current_user.role in ['client_admin','jusb_admin'] %}
  <form method="POST" action="{{ url_for('tickets.assign', ticket_id=ticket.id) }}">
    <h3 class="text-lg font-semibold mb-2">Assign</h3>
    {{ assign_form.hidden_tag() }}
    <div class="mb-3">{{ assign_form.assignee(class="border rounded px-2 py-1", value=ticket.assigned_to_id or 0) }}</div>
    {{ assign_form.submit(class="bg-emerald-600 hover:bg-emerald-700 text-white font-medium px-4 py-2 rounded") }}
  </form>
  {% endif %}
</div>
{% endblock %}
